# Конфигурирование

- [Введение](#introduction)
- [Конфигурация окружения](#environment-configuration)
    - [Типы переменных окружения](#environment-variable-types)
    - [Получение конфигурации окружения](#retrieving-environment-configuration)
    - [Определение текущего окружения](#determining-the-current-environment)
- [Доступ к значениям конфигурации](#accessing-configuration-values)
- [Кэширование конфигурации](#configuration-caching)
- [Режим отладки](#debug-mode)
- [Режим обслуживания](#maintenance-mode)

<a name="introduction"></a>
## Введение

Все файлы конфигурации фреймворка Laravel хранятся в каталоге `config`. Каждый параметр задокументирован, поэтому не стесняйтесь просматривать файлы и знакомиться с доступными вам вариантами.

Эти файлы конфигурации позволяют настраивать такие вещи, как информация о подключении к базе данных, информация о почтовом сервере, а также различные другие основные значения конфигурации, такие как часовой пояс приложения и ключ шифрования.

<a name="environment-configuration"></a>
## Конфигурация окружения

Часто бывает полезно иметь разные значения конфигурации в зависимости от окружения, в которой выполняется приложение. Например, вы можете захотеть использовать локально другой драйвер кэша, чем на сервере при эксплуатации.

Чтобы упростить это, Laravel использует библиотеку PHP [DotEnv](https://github.com/vlucas/phpdotenv). В свежей установке Laravel корневой каталог вашего приложения будет содержать файл `.env.example`, который определяет многие общие переменные окружения. В процессе установки Laravel этот файл будет автоматически скопирован в `.env`.

Файл `.env` Laravel по умолчанию содержит некоторые общие значения конфигурации, которые могут отличаться в зависимости от того, работает ли ваше приложение локально или на конечном веб-сервере. Затем эти значения извлекаются из различных файлов конфигурации Laravel каталога `config` с помощью функции Laravel `env()`.

Если вы работаете в команде, вы можете не исключать файл `.env.example` из своего приложения. Размещая значения-заполнители в этот файл, другие разработчики в вашей команде могут четко видеть, какие переменные окружения необходимы для запуска вашего приложения.

> {tip} Любая переменная в вашем файле `.env` может быть переопределена внешними переменными окружения, такими как переменные окружения уровня сервера или системы.

<a name="environment-file-security"></a>
#### Безопасность файлов окружения

Ваш файл `.env` не должен быть привязан к системе контроля версий вашего приложения, поскольку каждому разработчику / серверу, использующему ваше приложение, может потребоваться другая конфигурация окружения. Кроме того, это будет угрозой безопасности в случае, если злоумышленник получит доступ к вашему репозиторию системы управления версиями, поскольку любые конфиденциальные учетные данные будут раскрыты.

<a name="environment-variable-types"></a>
### Типы переменных окружения

Все переменные в файлах `.env` обычно анализируются как строки, поэтому были созданы некоторые зарезервированные значения, позволяющие вам возвращать более широкий диапазон типов из функции `env()`:

Значение `.env`  | Значение `env()`
------------- | -------------
true | (bool) true
(true) | (bool) true
false | (bool) false
(false) | (bool) false
empty | (string) ''
(empty) | (string) ''
null | (null) null
(null) | (null) null

Если вам нужно определить переменную окружения со значением, содержащим пробелы, вы можете сделать это, заключив значение в двойные кавычки:

    APP_NAME="My Application"

<a name="retrieving-environment-configuration"></a>
### Получение конфигурации окружения

Все переменные, перечисленные в этом файле, будут загружены в суперглобальную переменную PHP `$_ENV`, когда ваше приложение получит запрос. Однако вы можете использовать помощник `env` для получения значений из переменных в ваших файлах конфигурации. Фактически, если вы просмотрите файлы конфигурации Laravel, вы заметите, что многие параметры уже используют этот помощник:

    'debug' => env('APP_DEBUG', false),

Второе значение, переданное в функцию `env`, является «значением по умолчанию». Это значение будет возвращено, если для данного ключа не существует переменной окружения.

<a name="determining-the-current-environment"></a>
### Определение текущего окружения

Текущая окружение приложения определяется с помощью переменной `APP_ENV` из вашего файла `.env`. Вы можете получить доступ к этому значению через метод `environment` [фасада](fasades.md) `App`:

    use Illuminate\Support\Facades\App;

    $environment = App::environment();

Вы также можете передать аргументы методу `environment`, чтобы определить, соответствует ли окружение переданному значению. Метод вернет `true`, если окружение соответствует любому из указанных значений:

    if (App::environment('local')) {
        // Локальное окружение ...
    }

    if (App::environment(['local', 'staging'])) {
        // Среда либо локальная, либо промежуточная ...
    }

> {tip} Определение текущего окружения приложения может быть отменено путем определения переменной окружения `APP_ENV` на уровне сервера.

<a name="accessing-configuration-values"></a>
## Доступ к значениям конфигурации

Вы можете легко получить доступ к своим значениям конфигурации, используя глобальный помощник `config` из любого места вашего приложения. Доступ к значениям конфигурации можно получить с помощью «точечной нотации», который включает имя файла и параметр, к которому вы хотите получить доступ. Также может быть указано значение по умолчанию, которое будет возвращено, если параметр конфигурации отсутствует:

    $value = config('app.timezone');

    // Получить значение по умолчанию, если значение конфигурации не существует ...
    $value = config('app.timezone', 'Asia/Seoul');

Чтобы установить значения конфигурации во время выполнения скрипта, передайте массив помощнику `config`:

    config(['app.timezone' => 'America/Chicago']);

<a name="configuration-caching"></a>
## Кэширование конфигурации

Чтобы ускорить работу вашего приложения, вы должны кэшировать все файлы конфигурации в один файл с помощью Artisan-команды `config:cache`. Это объединит все параметры конфигурации вашего приложения в один файл, который может быть быстро загружен фреймворком.

Обычно вы должны запускать команду `php artisan config:cache` как часть процесса развертывания эксплуатационного режима. Команду не следует запускать во время локальной разработки, поскольку параметры конфигурации часто нужно будет изменять в ходе разработки вашего приложения.

> {note} Если вы выполняете команду `config:cache` в процессе развертывания, вы должны быть уверены, что вызываете только функцию `env` из ваших файлов конфигурации. После кэширования конфигурации файл `.env` не будет загружен, и все вызовы функции `env` вернут `null`.

<a name="debug-mode"></a>
## Режим отладки

Параметр `debug` в конфигурационном файле `config/app.php` определяет, сколько информации об ошибке фактически отображается конечному пользователю. По умолчанию эта опция установлена, чтобы учитывать значение переменной окружения `APP_DEBUG`, которая расположена в вашем файле `.env`.

Для локальной разработки вы должны установить для переменной окружения `APP_DEBUG` значение `true`. **В эксплуатационном режиме это значение всегда должно быть `false`. Если для этой переменной будет установлено значение `true`, вы рискуете раскрыть конфиденциальные значения конфигурации конечным пользователям вашего приложения.**

<a name="maintenance-mode"></a>
## Режим обслуживания

Когда ваше приложение находится в режиме обслуживания, то для всех запросов к приложению будет отображаться специальная страница. Это позволяет легко «отключить» ваше приложение во время его обновления или обслуживания. Проверка режима обслуживания включена в стек посредников по умолчанию для вашего приложения. Если приложение находится в режиме обслуживания, будет выброшено исключение `MaintenanceModeException` с кодом состояния 503.

Чтобы включить режим обслуживания, выполните Artisan-команду `down`:

    php artisan down

Вы также можете передать параметр `retry` команде `down`, значение которого будет установлено в HTTP-заголовке `Retry-After`:

    php artisan down --retry=60

<a name="bypassing-maintenance-mode"></a>
#### Обход режима обслуживания

Находясь в режиме обслуживания, вы можете использовать параметр `secret`, чтобы указать токен обхода режима обслуживания:

    php artisan down --secret="1630542a-246b-4b66-afa1-dd72a4c43515"

После перевода приложения в режим обслуживания вы можете перейти по URL-адресу приложения, соответствующему этому токену, и Laravel выдаст вашему браузеру файл куки для обхода режима обслуживания:

    https://example.com/1630542a-246b-4b66-afa1-dd72a4c43515

При доступе к этому скрытому маршруту вы будете перенаправлены на маршрут `/` приложения. Как только куки будет отправлен вашему браузеру, вы сможете просматривать приложение в обычном режиме, как если бы оно не находилось в режиме обслуживания.

<a name="pre-rendering-the-maintenance-mode-view"></a>
#### Предварительный рендеринг шаблона режима обслуживания

Если вы используете команду `php artisan down` во время развертывания, ваши пользователи могут иногда сталкиваться с ошибками, если они обращаются к приложению во время обновления ваших зависимостей Composer или других компонентов фреймворка. Это происходит потому, что значительная часть фреймворка Laravel должна загружаться, чтобы определить, находится ли ваше приложение в режиме обслуживания, и отобразить шаблон режима обслуживания с помощью механизма шаблонов.

По этой причине Laravel позволяет предварительно визуализировать шаблон режима обслуживания, который будет возвращен в самом начале цикла запроса. Этот шаблон отображается перед загрузкой любых зависимостей вашего приложения. Вы можете выполнить предварительный рендеринг шаблона по вашему выбору, используя параметр `render` команды `down`:

    php artisan down --render="errors::503"

<a name="redirecting-maintenance-mode-requests"></a>
#### Перенаправление запросов режима обслуживания

В режиме обслуживания Laravel будет отображать шаблон режима обслуживания для всех URL-адресов приложений, к которым пользователь попытается получить доступ. Если хотите, то вы можете указать Laravel перенаправлять все запросы на определенный URL. Это может быть выполнено с помощью параметра `redirect`. Например, вы можете перенаправить все запросы на URI `/`:

<a name="disabling-maintenance-mode"></a>
#### Отключение режима обслуживания

Чтобы отключить режим обслуживания, используйте команду `up`:

    php artisan up

> {tip} Вы можете определить свой шаблон режима обслуживания по умолчанию в `resources/views/errors/503.blade.php`.

<a name="maintenance-mode-queues"></a>
#### Режим обслуживания и очереди

Пока ваше приложение находится в режиме обслуживания, [поставленные в очередь задания](queues.md) обрабатываться не будут. Задания продолжат обрабатываться в обычном режиме после выхода приложения из режима обслуживания.

<a name="alternatives-to-maintenance-mode"></a>
#### Альтернативы режиму обслуживания

Поскольку режим обслуживания требует, чтобы ваше приложение простаивало несколько секунд, рассмотрите альтернативы, такие как [Laravel Vapor](https://vapor.laravel.com) и [Envoyer](https://envoyer.io), чтобы выполнить развертывание с нулевым временем простоя.
